---
title: "DATA 607 Final Project: Predicting Financial Well Being"
author: "David Simbandumwe"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: github
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(utils)

library(tidyverse)
library(tidymodels)
library(textrecipes)
library(discrim)
library(dplyr)
library(plyr)
library(naivebayes)

library(glue)
library(vip)

library(GGally)

```


# Overview



## Setup

```{r, results="hide"}

set.seed(1234)
rm(list=ls())

```


```{r, include=FALSE, error=TRUE}

fun_file_name <- glue(getwd(), "/ProjectFinal/DATA607_Functions.R")
source(fun_file_name)


```


## Functions


# Consumer Financial Protection Bureau


## Download and Tidy dataset from CFPB

```{r}

cfpb_df <- getCFPBFile()

cfpb_df <- slice_sample(cfpb_df,n=5000) 
#cfpb_df <- cfpb_df %>% select(-c(sample_pop,poverty_stat,fs_skills_score,fs_lm_score, fs_kh_score))

 # cfpb_df <- cfpb_df %>% select(cfpb_score, edu_level, race, hh_arrange, hh_size, econ_save_rate,
 #                               house_value, house_mortgage, econ_hh_income, age_8cat, region_9base)
 

  cfpb_df <- cfpb_df %>% select(cfpb_score, econ_hh_income, econ_save_rate, house_value, house_mortgage, age_8cat, race)
 

# split data
cfpb_split <- initial_split(cfpb_df, prop = 0.8, strata = cfpb_score)
cfpb_training <-  training(cfpb_split)
cfpb_test <-  testing(cfpb_split)

```


## Linear Regression



### fit traingin data

```{r}

# Model Specification
lm_model <- linear_reg() %>% 
            set_engine('lm') %>% 
            set_mode('regression')

#lm_model



# Fitting to Trained Data
lm_fit <- lm_model %>% 
          fit(cfpb_score ~ ., data = cfpb_training)


# Explore Training Results
names(lm_fit)
#summary(lm_fit$fit)


par(mfrow=c(2,2)) 

plot(lm_fit$fit, pch = 16, col = '#006EA1')

```



```{r}


summary(lm_fit$fit)


t <- tidy(lm_fit)
t$p.value <- round(t$p.value,4)
#t <- t %>% filter(p.value < 0.05)


```


### training results

```{r}

# Data frame of estimated coefficients
tidy(lm_fit)


# Performance metrics on training data
glance(lm_fit)  

# variable importance
vip(lm_fit, num_features=25)


```


## Evaluating Test Set Accuracy

```{r}

predict(lm_fit, new_data = cfpb_test)

cfpb_results <- predict(lm_fit, new_data = cfpb_test) %>% 
                            bind_cols(cfpb_test)

cfpb_results

# RMSE on test set
rmse(cfpb_results, truth = cfpb_score, estimate = .pred)

# R2 on test set
rsq(cfpb_results, truth = cfpb_score, estimate = .pred)

```




```{r}

ggplot(data = cfpb_results,
       mapping = aes(x = .pred, y = cfpb_score)) +
  geom_point(color = '#006EA1') +
  geom_smooth(method = lm) +
  geom_abline(intercept = 0, slope = 1, color = 'orange') +
  labs(title = 'Linear Regression Results - CFPB Score',
       x = 'Predicted',
       y = 'Actual')


```



## Linear Regression [Machine Learning Workflow]

```{r}

# # Create a split object
# cfpb_split <- initial_split(cfpb_df, prop = 0.8,strata = cfpb_score)
# 
# # Build training data set
# cfpb_training <- training(cfpb_split)
# 
# # Build testing data set
# cfpb_test <- testing(cfpb_split)


```



### feature engineering

```{r}

cfpb_recipe2 <- recipe(cfpb_score ~ ., data = cfpb_training) %>% 
                      step_YeoJohnson(all_numeric(), -all_outcomes()) %>% 
                      step_normalize(all_numeric(), -all_outcomes())


```



### specify model

```{r}

lm_model <- linear_reg() %>% 
            set_engine('lm') %>% 
            set_mode('regression')


```




### workflow

```{r}

cfpb_workflow <- workflow() %>% 
                        add_model(lm_model) %>% 
                        add_recipe(cfpb_recipe2)

cfpb_fit <- cfpb_workflow %>% 
                   last_fit(split = cfpb_split)

```



### model testing

```{r}

# Obtain performance metrics on test data
cfpb_fit %>% collect_metrics()

cfpb_results2 <- cfpb_fit %>% 
                collect_predictions()

cfpb_results2



# RMSE on test set
rmse(cfpb_results2, truth = cfpb_score, estimate = .pred)
rsq(cfpb_results2, truth = cfpb_score, estimate = .pred)


# plot results
ggplot(data = cfpb_results2,
       mapping = aes(x = .pred, y = cfpb_score)) +
  geom_point(color = '#006EA1') +
  geom_smooth(method = lm) +
  geom_abline(intercept = 0, slope = 1, color = 'orange') +
  labs(title = 'Linear Regression[ML] - CFPB Score',
       x = 'Predicted',
       y = 'Actual')

```





# Federal Reserve


## Download and Tidy dataset from FEd

```{r}

fed_df <- getFedFile()

fed_df <- slice_sample(fed_df,n=5000) 
# fed_df <- fed_df %>% select(-c(age_4cat, age_7cat, starts_with("age_"),starts_with("hh_child_")
#                                ,race_census
#                                ))

# fed_df <- fed_df %>% select(cfpb_score, gender, age, marital_status, household_size, emp_status,
#                   health, edu_level, credit_guess, econ_saving, econ_inc_4cat, econ_hh_income,
#                   econ_fin_ok, econ_pay_exp400,econ_skip_med)
# 
# fed_df <- fed_df %>% select(cfpb_score, age, emp_status,
#                   health, credit_guess, econ_saving, econ_inc_4cat,
#                   econ_fin_ok, econ_pay_exp400,econ_skip_med)


# fed_df <- fed_df %>% select(cfpb_score, age,
#                   health, credit_guess, econ_saving, econ_inc_4cat,
#                   econ_fin_ok, econ_pay_exp400,econ_skip_med)


fed_df <- fed_df %>% select(cfpb_score, econ_fin_ok, econ_skip_med, econ_pay_exp400, age, econ_saving, health)


# split data
fed_split <- initial_split(fed_df, prop = 0.8, strata = cfpb_score)
fed_training <- training(fed_split)
fed_test <- testing(fed_split)



count(fed_df$race_census)

```


## Linear Regression


### fit traingin data

```{r}

# Model Specification
lm_model <- linear_reg() %>% 
            set_engine('lm') %>% 
            set_mode('regression')

#lm_model



# Fitting to Trained Data
lm_fit <- lm_model %>% 
          fit(cfpb_score ~ ., data = fed_training)

#lm_fit


# Explore Training Results
names(lm_fit)
#summary(lm_fit$fit)


par(mfrow=c(2,2)) 

plot(lm_fit$fit, pch = 16, col = '#006EA1')

```


```{r}

summary(lm_fit$fit)


t <- tidy(lm_fit)
t$p.value <- round(t$p.value,4)
t <- t %>% filter(p.value < 0.05)


```




### training results

```{r}

# Data frame of estimated coefficients
tidy(lm_fit)
summary(lm_fit$fit)


# Performance metrics on training data
glance(lm_fit)  

# variable importance
vip(lm_fit, num_features=30)

```


## Evaluating Test Set Accuracy

```{r}

predict(lm_fit, new_data = fed_test)

fed_results <- predict(lm_fit, new_data = fed_test) %>% 
                            bind_cols(fed_test)

fed_results


```



```{r}

# RMSE on test set
rmse(fed_results, truth = cfpb_score, estimate = .pred)

# R2 on test set
rsq(fed_results, truth = cfpb_score, estimate = .pred)


```



```{r}

ggplot(data = fed_results,
       mapping = aes(x = .pred, y = cfpb_score)) +
  geom_point(color = '#006EA1') +
  geom_smooth(method = lm) +
  geom_abline(intercept = 0, slope = 1, color = 'orange') +
  labs(title = 'Linear Regression - Fed CFPB Score',
       x = 'Predicted',
       y = 'Actual')


```



## Linear Regression [Machine Learning Workflow]

```{r}

# # Create a split object
# fed_split <- initial_split(fed_df, prop = 0.8, strata = cfpb_score)
# 
# # Build training data set
# fed_training <- training(fed_split)
# 
# # Build testing data set
# fed_test <- testing(fed_split)
# 

```



### feature engineering

```{r}

fed_recipe <- recipe(cfpb_score ~ ., data = fed_training) %>% 
                      step_YeoJohnson(all_numeric(), -all_outcomes()) %>% 
                      step_normalize(all_numeric(), -all_outcomes())


```



### specify model

```{r}

lm_model <- linear_reg() %>% 
            set_engine('lm') %>% 
            set_mode('regression')


```




### workflow

```{r}

fed_workflow <- workflow() %>% 
                        add_model(lm_model) %>% 
                        add_recipe(fed_recipe)

fed_fit <- fed_workflow %>% 
                   last_fit(split = fed_split)



```









### model testing

```{r}

# Obtain performance metrics on test data
test_performance <- fed_fit %>% collect_metrics()
fed_results2 <- fed_fit %>% collect_predictions()


# RMSE on test set
rmse(fed_results2, truth = cfpb_score, estimate = .pred)
rsq(fed_results2, truth = cfpb_score, estimate = .pred)


# plot results
ggplot(data = fed_results2,
       mapping = aes(x = .pred, y = cfpb_score)) +
  geom_point(color = '#006EA1') +
  geom_smooth(method = lm) +
  geom_abline(intercept = 0, slope = 1, color = 'orange') +
  labs(title = 'Linear Regression [ML] - Fed CFPB Score',
       x = 'Predicted ',
       y = 'Actual ')

```

### fitting the final model

```{r}

final_model <- fit(fed_workflow, fed_df)
final_model


ranger_obj <- extract_fit_parsnip(final_model)$fit
ranger_obj

```



# Analysis


# Conclusion
	
	
	
	
	
	
	
